import random
# Χρησιμοποιείται για την παραγωγή τυχαίων χρονικών διαστημάτων
# μεταξύ των αλλαγών μορφής του εχθρού

from shared.model.types import MonsterForm
# Εισάγουμε το enum MonsterForm που περιγράφει τη μορφή του εχθρού
# (π.χ. NOBBIN, HOBBIN)


class EnemyFormSystem:
    """
    Το EnemyFormSystem είναι υπεύθυνο για τη δυναμική αλλαγή
    της μορφής ενός εχθρού κατά τη διάρκεια του παιχνιδιού.

    Συγκεκριμένα:
    - Εναλλάσσει τον εχθρό μεταξύ NOBBIN και HOBBIN
    - Η αλλαγή γίνεται μετά από τυχαίο χρονικό διάστημα
    - Η λογική είναι ανεξάρτητη από AI, κίνηση ή collisions
    """

    def __init__(self):
        """
        Constructor του συστήματος.
        Δεν απαιτεί αρχικοποίηση μεταβλητών, επειδή
        τα timers αποθηκεύονται δυναμικά πάνω στο αντικείμενο enemy.
        """
        pass

    def update(self, enemy, dt):
        """
        Ενημερώνει την κατάσταση της μορφής ενός εχθρού.

        enemy : το αντικείμενο Enemy που ενημερώνουμε
        dt    : ο χρόνος (σε δευτερόλεπτα) που πέρασε από το προηγούμενο frame
        """

        # ==================================================
        # SAFE INITIALIZATION
        # ==================================================

        # Αν ο εχθρός δεν έχει ακόμα χρονόμετρο μορφής,
        # το δημιουργούμε δυναμικά (πρώτο update)
        if not hasattr(enemy, "form_timer"):
            enemy.form_timer = 0.0

        # Αν δεν υπάρχει προγραμματισμένος χρόνος αλλαγής μορφής,
        # δημιουργούμε έναν τυχαίο (μεταξύ 4 και 9 δευτερολέπτων)
        if not hasattr(enemy, "next_form_change"):
            enemy.next_form_change = random.uniform(4.0, 9.0)

        # ==================================================
        # UPDATE TIMER
        # ==================================================

        # Αυξάνουμε τον μετρητή χρόνου με βάση το dt
        enemy.form_timer += dt

        # Αν δεν έχει φτάσει ακόμα ο χρόνος αλλαγής μορφής,
        # σταματάμε εδώ και δεν κάνουμε τίποτα άλλο
        if enemy.form_timer < enemy.next_form_change:
            return

        # ==================================================
        # TOGGLE FORM
        # ==================================================

        # Αν ο εχθρός είναι NOBBIN,
        # μετατρέπεται σε HOBBIN (πιο επικίνδυνη μορφή)
        if enemy.form == MonsterForm.NOBBIN:
            enemy.form = MonsterForm.HOBBIN
        else:
            # Αν είναι ήδη HOBBIN,
            # επιστρέφει στη βασική μορφή NOBBIN
            enemy.form = MonsterForm.NOBBIN

        # ==================================================
        # RESET TIMERS
        # ==================================================

        # Μηδενίζουμε τον μετρητή χρόνου
        enemy.form_timer = 0.0

        # Ορίζουμε νέο τυχαίο χρόνο για την επόμενη αλλαγή μορφής
        enemy.next_form_change = random.uniform(4.0, 9.0)
