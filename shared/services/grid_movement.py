from shared.model.types import Direction
# Εισάγουμε το enum Direction, το οποίο ορίζει
# τις επιτρεπτές κατευθύνσεις κίνησης (UP, DOWN, LEFT, RIGHT).


# Πίνακας αντιστοίχισης κατεύθυνσης → μετατόπιση στο grid
# Κάθε κατεύθυνση μεταφράζεται σε (dx, dy)
# όπου:
#   dx = μεταβολή στον άξονα x (στήλες)
#   dy = μεταβολή στον άξονα y (γραμμές)
DIR_VECTORS = {
    Direction.UP: (0, -1),     # πάνω: ίδια στήλη, μία γραμμή πάνω
    Direction.DOWN: (0, 1),    # κάτω: ίδια στήλη, μία γραμμή κάτω
    Direction.LEFT: (-1, 0),   # αριστερά: μία στήλη αριστερά
    Direction.RIGHT: (1, 0),   # δεξιά: μία στήλη δεξιά
}


class GridMovementSystem:
    """
    Το GridMovementSystem είναι υπεύθυνο για την κίνηση
    οντοτήτων μέσα σε ένα grid (πλέγμα πλακιδίων).

    Δεν γνωρίζει:
    - αν η οντότητα είναι παίκτης ή εχθρός
    - τι υπάρχει στο πλακίδιο
    - αν η κίνηση είναι «καλή» ή «κακή» για το gameplay

    Ασχολείται αποκλειστικά με:
    - τον υπολογισμό της νέας θέσης
    - τον έλεγχο ορίων του επιπέδου
    """

    def try_move(self, entity, direction, level):
        """
        Προσπαθεί να μετακινήσει μια οντότητα κατά ένα πλακίδιο.

        entity    : το αντικείμενο που κινείται (Player, Enemy κ.λπ.)
        direction : κατεύθυνση κίνησης (Direction enum)
        level     : το επίπεδο του παιχνιδιού (χρησιμοποιείται για έλεγχο ορίων)

        Επιστρέφει:
        - True  αν η κίνηση πραγματοποιήθηκε
        - False αν η κίνηση απορρίφθηκε
        """

        # Αν η κατεύθυνση δεν είναι έγκυρη,
        # δεν επιχειρούμε καν κίνηση
        if direction not in DIR_VECTORS:
            return False

        # Παίρνουμε το διάνυσμα κίνησης (dx, dy)
        dx, dy = DIR_VECTORS[direction]

        # Υπολογίζουμε τη νέα θέση στο grid
        nx = entity.tile_x + dx
        ny = entity.tile_y + dy

        # Ελέγχουμε αν η νέα θέση βρίσκεται εντός των ορίων του επιπέδου
        if not level.in_bounds(nx, ny):
            return False

        # Αν φτάσαμε εδώ, η κίνηση επιτρέπεται
        # Ενημερώνουμε τις συντεταγμένες της οντότητας
        entity.tile_x = nx
        entity.tile_y = ny

        # Αν η οντότητα διαθέτει ιδιότητα "direction"
        # (π.χ. Player, αλλά όχι απαραίτητα Enemy),
        # αποθηκεύουμε τη φορά που κοιτάζει
        if hasattr(entity, "direction"):
            entity.direction = direction

        # Δηλώνουμε επιτυχία κίνησης
        return True
